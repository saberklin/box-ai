# 🎵 云端管理员曲库管理接口文档

## 📋 概述

本文档详细说明云端管理员用于曲库管理的所有API接口，包括歌曲的增删改查、媒体文件上传、同步版本控制等核心功能。

## 🏗️ 系统架构

```
云端管理后台 → AdminTrackController → AdminTrackService → 数据库 + CDN
                                                              ↓
                                                        包间同步更新
```

## 📚 核心操作分类

### 1. 📝 歌曲信息管理

#### 1.1 新增歌曲
```http
POST /api/admin/tracks
Content-Type: application/json

{
  "title": "告白气球",
  "artist": "周杰伦",
  "album": "周杰伦的床边故事",
  "category": "流行",
  "language": "中文",
  "genre": "流行/R&B",
  "tags": "经典,热门,KTV必唱",
  "duration": 240,
  "videoQuality": "1080P",
  "audioQuality": "320K",
  "coverUrl": "https://cdn.example.com/covers/12345.jpg",
  "lyricsUrl": "https://cdn.example.com/lyrics/12345.lrc",
  "previewUrl": "https://cdn.example.com/preview/12345.mp3",
  "copyrightInfo": "华研国际音乐股份有限公司",
  "isNew": true,
  "isHot": false,
  "isRecommended": false,
  "status": "ACTIVE"
}
```

**功能说明**：
- 自动分配同步版本号 `sync_version = 1`
- 设置创建时间和更新时间
- 初始化播放统计数据

#### 1.2 更新歌曲信息
```http
PUT /api/admin/tracks/{id}
Content-Type: application/json

{
  "title": "告白气球（修正版）",
  "artist": "周杰伦",
  "isHot": true,
  "forceUpdateVersion": true
}
```

**功能说明**：
- 支持部分字段更新
- `forceUpdateVersion=true` 强制更新同步版本
- 重要字段变更自动更新版本号
- 更新 `last_sync_at` 时间戳

#### 1.3 删除歌曲
```http
DELETE /api/admin/tracks/{id}?reason=版权到期
```

**功能说明**：
- 软删除，状态改为 `DELETED`
- 自动更新同步版本号
- 包间会同步删除本地文件

### 2. 📁 媒体文件管理

#### 2.1 上传媒体文件
```http
POST /api/admin/tracks/{id}/media/upload
Content-Type: multipart/form-data

file: [媒体文件]
trackId: 1001
fileType: VIDEO  # VIDEO/AUDIO/COVER/LYRICS
originalFileName: 告白气球.mp4
fileSize: 52428800
fileMd5: d41d8cd98f00b204e9800998ecf8427e
quality: 1080P
remark: 高清版本
```

**响应示例**：
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "uploadId": "upload_1693123456789",
    "cdnUrl": "https://cdn.example.com/media/1001/video.mp4",
    "fileSize": 52428800,
    "uploadStatus": "SUCCESS",
    "message": "文件上传成功",
    "fileMd5": "d41d8cd98f00b204e9800998ecf8427e"
  }
}
```

**功能说明**：
- 支持视频、音频、封面、歌词文件上传
- 自动生成CDN链接
- 更新歌曲的媒体信息字段
- 自动递增同步版本号
- MD5校验确保文件完整性

#### 2.2 文件类型说明

| 文件类型 | 更新字段 | 支持格式 | 说明 |
|---------|---------|---------|------|
| VIDEO | `fileSize`, `videoQuality` | MP4, AVI, MKV | 主要播放文件 |
| AUDIO | `fileSize`, `audioQuality` | MP3, FLAC, WAV | 纯音频版本 |
| COVER | `coverUrl` | JPG, PNG | 歌曲封面图片 |
| LYRICS | `lyricsUrl` | LRC, TXT | 歌词文件 |

### 3. 🔄 同步版本管理

#### 3.1 批量更新同步版本
```http
POST /api/admin/tracks/sync-version/update
Content-Type: application/json

{
  "trackIds": [1001, 1002, 1003],
  "reason": "批量更新高清版本",
  "forcePushToAllRooms": false,
  "targetRoomIds": [1, 2, 3]
}
```

**响应示例**：
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "successCount": 2,
    "failedCount": 1,
    "errors": ["歌曲不存在: 1003"],
    "reason": "批量更新高清版本",
    "updateTime": "2024-08-29T16:30:00"
  }
}
```

#### 3.2 获取待同步歌曲列表
```http
GET /api/admin/tracks/sync-version/pending?page=1&size=20&roomId=1001
```

**功能说明**：
- 查询需要推送到包间的歌曲更新
- 支持按包间过滤
- 分页返回结果

#### 3.3 强制推送更新
```http
POST /api/admin/tracks/sync-version/force-push
Content-Type: application/json

[1001, 1002, 1003]
```

**查询参数**：
- `roomIds`: 目标包间ID列表（可选，为空则推送到所有包间）

### 4. 📊 统计和监控

#### 4.1 获取曲库统计信息
```http
GET /api/admin/tracks/statistics?days=30
```

**响应示例**：
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "totalTracks": 3300,
    "newTracks": 150,
    "activeTracks": 3300,
    "deletedTracks": 45,
    "categoryStats": {
      "流行": 1500,
      "摇滚": 800,
      "民谣": 600,
      "电子": 400
    },
    "languageStats": {
      "中文": 2000,
      "英文": 1000,
      "日文": 200,
      "韩文": 100
    },
    "statisticsDate": "2024-08-29T16:30:00",
    "statisticsDays": 30
  }
}
```

#### 4.2 获取同步日志
```http
GET /api/admin/tracks/sync-logs?page=1&size=20&trackId=1001&roomId=2001&syncStatus=SUCCESS
```

**功能说明**：
- 查看歌曲同步到各包间的详细日志
- 支持按歌曲、包间、同步状态过滤
- 包含同步时间、文件路径、错误信息等

### 5. 📥📤 批量操作

#### 5.1 批量导入歌曲
```http
POST /api/admin/tracks/batch-import
Content-Type: multipart/form-data

file: [Excel或CSV文件]
overwrite: false
```

**Excel格式要求**：
| 标题 | 歌手 | 专辑 | 分类 | 语言 | 风格 | 标签 | 时长 | 状态 |
|------|------|------|------|------|------|------|------|------|
| 告白气球 | 周杰伦 | 周杰伦的床边故事 | 流行 | 中文 | 流行/R&B | 经典,热门 | 240 | ACTIVE |

#### 5.2 导出曲库数据
```http
GET /api/admin/tracks/export?format=EXCEL&status=ACTIVE&category=流行
```

**支持参数**：
- `format`: EXCEL, CSV, JSON
- `status`: 状态过滤
- `category`: 分类过滤

## 🔐 权限和安全

### 权限要求
所有管理员接口需要以下权限：
- 管理员身份验证
- `ADMIN_TRACK_MANAGE` 权限
- IP白名单限制（推荐）

### 安全措施
- JWT Token认证
- 操作日志记录
- 文件类型验证
- 文件大小限制
- MD5完整性校验

## 🚀 使用流程示例

### 完整的歌曲上线流程

1. **创建歌曲记录**
```bash
curl -X POST "http://localhost:9998/api/admin/tracks" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {admin_token}" \
  -d '{
    "title": "新歌测试",
    "artist": "测试歌手",
    "category": "流行",
    "language": "中文"
  }'
```

2. **上传视频文件**
```bash
curl -X POST "http://localhost:9998/api/admin/tracks/1001/media/upload" \
  -H "Authorization: Bearer {admin_token}" \
  -F "file=@新歌测试.mp4" \
  -F "fileType=VIDEO" \
  -F "quality=1080P"
```

3. **上传封面图片**
```bash
curl -X POST "http://localhost:9998/api/admin/tracks/1001/media/upload" \
  -H "Authorization: Bearer {admin_token}" \
  -F "file=@封面.jpg" \
  -F "fileType=COVER"
```

4. **上传歌词文件**
```bash
curl -X POST "http://localhost:9998/api/admin/tracks/1001/media/upload" \
  -H "Authorization: Bearer {admin_token}" \
  -F "file=@歌词.lrc" \
  -F "fileType=LYRICS"
```

5. **强制推送到所有包间**
```bash
curl -X POST "http://localhost:9998/api/admin/tracks/sync-version/force-push" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {admin_token}" \
  -d '[1001]'
```

## 📝 同步版本管理说明

### 版本号规则
- 新歌曲创建：`sync_version = 1`
- 重要更新：`sync_version += 1`
- 媒体文件更新：`sync_version += 1`
- 删除操作：`sync_version += 1`

### 自动更新版本的情况
- 歌曲标题、歌手名变更
- 封面图片更新
- 状态变更（ACTIVE → DELETED）
- 媒体文件上传
- 强制更新标志 `forceUpdateVersion=true`

### 包间同步机制
1. 包间定时检查云端更新（每小时）
2. 比较本地 `sync_version` 与云端版本
3. 下载更新的媒体文件
4. 更新本地歌曲信息
5. 记录同步日志

## 🔧 错误处理

### 常见错误码
- `404`: 歌曲不存在
- `400`: 请求参数错误
- `413`: 文件过大
- `415`: 不支持的文件格式
- `500`: 服务器内部错误

### 错误响应格式
```json
{
  "code": 404,
  "message": "歌曲不存在",
  "data": null,
  "timestamp": "2024-08-29T16:30:00"
}
```

## 📈 监控指标

建议监控以下关键指标：
- 每日新增歌曲数量
- 媒体文件上传成功率
- 包间同步成功率
- 平均同步延迟时间
- CDN带宽使用情况
- 存储空间使用情况

---

通过这套完整的云端管理接口，管理员可以高效地管理整个曲库系统，确保所有包间都能及时获得最新的歌曲内容和更新。
