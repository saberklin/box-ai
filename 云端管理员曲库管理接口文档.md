# ğŸµ äº‘ç«¯ç®¡ç†å‘˜æ›²åº“ç®¡ç†æ¥å£æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº‘ç«¯ç®¡ç†å‘˜ç”¨äºæ›²åº“ç®¡ç†çš„æ‰€æœ‰APIæ¥å£ï¼ŒåŒ…æ‹¬æ­Œæ›²çš„å¢åˆ æ”¹æŸ¥ã€åª’ä½“æ–‡ä»¶ä¸Šä¼ ã€åŒæ­¥ç‰ˆæœ¬æ§åˆ¶ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
äº‘ç«¯ç®¡ç†åå° â†’ AdminTrackController â†’ AdminTrackService â†’ æ•°æ®åº“ + CDN
                                                              â†“
                                                        åŒ…é—´åŒæ­¥æ›´æ–°
```

## ğŸ“š æ ¸å¿ƒæ“ä½œåˆ†ç±»

### 1. ğŸ“ æ­Œæ›²ä¿¡æ¯ç®¡ç†

#### 1.1 æ–°å¢æ­Œæ›²
```http
POST /api/admin/tracks
Content-Type: application/json

{
  "title": "å‘Šç™½æ°”çƒ",
  "artist": "å‘¨æ°ä¼¦",
  "album": "å‘¨æ°ä¼¦çš„åºŠè¾¹æ•…äº‹",
  "category": "æµè¡Œ",
  "language": "ä¸­æ–‡",
  "genre": "æµè¡Œ/R&B",
  "tags": "ç»å…¸,çƒ­é—¨,KTVå¿…å”±",
  "duration": 240,
  "videoQuality": "1080P",
  "audioQuality": "320K",
  "coverUrl": "https://cdn.example.com/covers/12345.jpg",
  "lyricsUrl": "https://cdn.example.com/lyrics/12345.lrc",
  "previewUrl": "https://cdn.example.com/preview/12345.mp3",
  "copyrightInfo": "åç ”å›½é™…éŸ³ä¹è‚¡ä»½æœ‰é™å…¬å¸",
  "isNew": true,
  "isHot": false,
  "isRecommended": false,
  "status": "ACTIVE"
}
```

**åŠŸèƒ½è¯´æ˜**ï¼š
- è‡ªåŠ¨åˆ†é…åŒæ­¥ç‰ˆæœ¬å· `sync_version = 1`
- è®¾ç½®åˆ›å»ºæ—¶é—´å’Œæ›´æ–°æ—¶é—´
- åˆå§‹åŒ–æ’­æ”¾ç»Ÿè®¡æ•°æ®

#### 1.2 æ›´æ–°æ­Œæ›²ä¿¡æ¯
```http
PUT /api/admin/tracks/{id}
Content-Type: application/json

{
  "title": "å‘Šç™½æ°”çƒï¼ˆä¿®æ­£ç‰ˆï¼‰",
  "artist": "å‘¨æ°ä¼¦",
  "isHot": true,
  "forceUpdateVersion": true
}
```

**åŠŸèƒ½è¯´æ˜**ï¼š
- æ”¯æŒéƒ¨åˆ†å­—æ®µæ›´æ–°
- `forceUpdateVersion=true` å¼ºåˆ¶æ›´æ–°åŒæ­¥ç‰ˆæœ¬
- é‡è¦å­—æ®µå˜æ›´è‡ªåŠ¨æ›´æ–°ç‰ˆæœ¬å·
- æ›´æ–° `last_sync_at` æ—¶é—´æˆ³

#### 1.3 åˆ é™¤æ­Œæ›²
```http
DELETE /api/admin/tracks/{id}?reason=ç‰ˆæƒåˆ°æœŸ
```

**åŠŸèƒ½è¯´æ˜**ï¼š
- è½¯åˆ é™¤ï¼ŒçŠ¶æ€æ”¹ä¸º `DELETED`
- è‡ªåŠ¨æ›´æ–°åŒæ­¥ç‰ˆæœ¬å·
- åŒ…é—´ä¼šåŒæ­¥åˆ é™¤æœ¬åœ°æ–‡ä»¶

### 2. ğŸ“ åª’ä½“æ–‡ä»¶ç®¡ç†

#### 2.1 ä¸Šä¼ åª’ä½“æ–‡ä»¶
```http
POST /api/admin/tracks/{id}/media/upload
Content-Type: multipart/form-data

file: [åª’ä½“æ–‡ä»¶]
trackId: 1001
fileType: VIDEO  # VIDEO/AUDIO/COVER/LYRICS
originalFileName: å‘Šç™½æ°”çƒ.mp4
fileSize: 52428800
fileMd5: d41d8cd98f00b204e9800998ecf8427e
quality: 1080P
remark: é«˜æ¸…ç‰ˆæœ¬
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "uploadId": "upload_1693123456789",
    "cdnUrl": "https://cdn.example.com/media/1001/video.mp4",
    "fileSize": 52428800,
    "uploadStatus": "SUCCESS",
    "message": "æ–‡ä»¶ä¸Šä¼ æˆåŠŸ",
    "fileMd5": "d41d8cd98f00b204e9800998ecf8427e"
  }
}
```

**åŠŸèƒ½è¯´æ˜**ï¼š
- æ”¯æŒè§†é¢‘ã€éŸ³é¢‘ã€å°é¢ã€æ­Œè¯æ–‡ä»¶ä¸Šä¼ 
- è‡ªåŠ¨ç”ŸæˆCDNé“¾æ¥
- æ›´æ–°æ­Œæ›²çš„åª’ä½“ä¿¡æ¯å­—æ®µ
- è‡ªåŠ¨é€’å¢åŒæ­¥ç‰ˆæœ¬å·
- MD5æ ¡éªŒç¡®ä¿æ–‡ä»¶å®Œæ•´æ€§

#### 2.2 æ–‡ä»¶ç±»å‹è¯´æ˜

| æ–‡ä»¶ç±»å‹ | æ›´æ–°å­—æ®µ | æ”¯æŒæ ¼å¼ | è¯´æ˜ |
|---------|---------|---------|------|
| VIDEO | `fileSize`, `videoQuality` | MP4, AVI, MKV | ä¸»è¦æ’­æ”¾æ–‡ä»¶ |
| AUDIO | `fileSize`, `audioQuality` | MP3, FLAC, WAV | çº¯éŸ³é¢‘ç‰ˆæœ¬ |
| COVER | `coverUrl` | JPG, PNG | æ­Œæ›²å°é¢å›¾ç‰‡ |
| LYRICS | `lyricsUrl` | LRC, TXT | æ­Œè¯æ–‡ä»¶ |

### 3. ğŸ”„ åŒæ­¥ç‰ˆæœ¬ç®¡ç†

#### 3.1 æ‰¹é‡æ›´æ–°åŒæ­¥ç‰ˆæœ¬
```http
POST /api/admin/tracks/sync-version/update
Content-Type: application/json

{
  "trackIds": [1001, 1002, 1003],
  "reason": "æ‰¹é‡æ›´æ–°é«˜æ¸…ç‰ˆæœ¬",
  "forcePushToAllRooms": false,
  "targetRoomIds": [1, 2, 3]
}
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "successCount": 2,
    "failedCount": 1,
    "errors": ["æ­Œæ›²ä¸å­˜åœ¨: 1003"],
    "reason": "æ‰¹é‡æ›´æ–°é«˜æ¸…ç‰ˆæœ¬",
    "updateTime": "2024-08-29T16:30:00"
  }
}
```

#### 3.2 è·å–å¾…åŒæ­¥æ­Œæ›²åˆ—è¡¨
```http
GET /api/admin/tracks/sync-version/pending?page=1&size=20&roomId=1001
```

**åŠŸèƒ½è¯´æ˜**ï¼š
- æŸ¥è¯¢éœ€è¦æ¨é€åˆ°åŒ…é—´çš„æ­Œæ›²æ›´æ–°
- æ”¯æŒæŒ‰åŒ…é—´è¿‡æ»¤
- åˆ†é¡µè¿”å›ç»“æœ

#### 3.3 å¼ºåˆ¶æ¨é€æ›´æ–°
```http
POST /api/admin/tracks/sync-version/force-push
Content-Type: application/json

[1001, 1002, 1003]
```

**æŸ¥è¯¢å‚æ•°**ï¼š
- `roomIds`: ç›®æ ‡åŒ…é—´IDåˆ—è¡¨ï¼ˆå¯é€‰ï¼Œä¸ºç©ºåˆ™æ¨é€åˆ°æ‰€æœ‰åŒ…é—´ï¼‰

### 4. ğŸ“Š ç»Ÿè®¡å’Œç›‘æ§

#### 4.1 è·å–æ›²åº“ç»Ÿè®¡ä¿¡æ¯
```http
GET /api/admin/tracks/statistics?days=30
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "totalTracks": 3300,
    "newTracks": 150,
    "activeTracks": 3300,
    "deletedTracks": 45,
    "categoryStats": {
      "æµè¡Œ": 1500,
      "æ‘‡æ»š": 800,
      "æ°‘è°£": 600,
      "ç”µå­": 400
    },
    "languageStats": {
      "ä¸­æ–‡": 2000,
      "è‹±æ–‡": 1000,
      "æ—¥æ–‡": 200,
      "éŸ©æ–‡": 100
    },
    "statisticsDate": "2024-08-29T16:30:00",
    "statisticsDays": 30
  }
}
```

#### 4.2 è·å–åŒæ­¥æ—¥å¿—
```http
GET /api/admin/tracks/sync-logs?page=1&size=20&trackId=1001&roomId=2001&syncStatus=SUCCESS
```

**åŠŸèƒ½è¯´æ˜**ï¼š
- æŸ¥çœ‹æ­Œæ›²åŒæ­¥åˆ°å„åŒ…é—´çš„è¯¦ç»†æ—¥å¿—
- æ”¯æŒæŒ‰æ­Œæ›²ã€åŒ…é—´ã€åŒæ­¥çŠ¶æ€è¿‡æ»¤
- åŒ…å«åŒæ­¥æ—¶é—´ã€æ–‡ä»¶è·¯å¾„ã€é”™è¯¯ä¿¡æ¯ç­‰

### 5. ğŸ“¥ğŸ“¤ æ‰¹é‡æ“ä½œ

#### 5.1 æ‰¹é‡å¯¼å…¥æ­Œæ›²
```http
POST /api/admin/tracks/batch-import
Content-Type: multipart/form-data

file: [Excelæˆ–CSVæ–‡ä»¶]
overwrite: false
```

**Excelæ ¼å¼è¦æ±‚**ï¼š
| æ ‡é¢˜ | æ­Œæ‰‹ | ä¸“è¾‘ | åˆ†ç±» | è¯­è¨€ | é£æ ¼ | æ ‡ç­¾ | æ—¶é•¿ | çŠ¶æ€ |
|------|------|------|------|------|------|------|------|------|
| å‘Šç™½æ°”çƒ | å‘¨æ°ä¼¦ | å‘¨æ°ä¼¦çš„åºŠè¾¹æ•…äº‹ | æµè¡Œ | ä¸­æ–‡ | æµè¡Œ/R&B | ç»å…¸,çƒ­é—¨ | 240 | ACTIVE |

#### 5.2 å¯¼å‡ºæ›²åº“æ•°æ®
```http
GET /api/admin/tracks/export?format=EXCEL&status=ACTIVE&category=æµè¡Œ
```

**æ”¯æŒå‚æ•°**ï¼š
- `format`: EXCEL, CSV, JSON
- `status`: çŠ¶æ€è¿‡æ»¤
- `category`: åˆ†ç±»è¿‡æ»¤

## ğŸ” æƒé™å’Œå®‰å…¨

### æƒé™è¦æ±‚
æ‰€æœ‰ç®¡ç†å‘˜æ¥å£éœ€è¦ä»¥ä¸‹æƒé™ï¼š
- ç®¡ç†å‘˜èº«ä»½éªŒè¯
- `ADMIN_TRACK_MANAGE` æƒé™
- IPç™½åå•é™åˆ¶ï¼ˆæ¨èï¼‰

### å®‰å…¨æªæ–½
- JWT Tokenè®¤è¯
- æ“ä½œæ—¥å¿—è®°å½•
- æ–‡ä»¶ç±»å‹éªŒè¯
- æ–‡ä»¶å¤§å°é™åˆ¶
- MD5å®Œæ•´æ€§æ ¡éªŒ

## ğŸš€ ä½¿ç”¨æµç¨‹ç¤ºä¾‹

### å®Œæ•´çš„æ­Œæ›²ä¸Šçº¿æµç¨‹

1. **åˆ›å»ºæ­Œæ›²è®°å½•**
```bash
curl -X POST "http://localhost:9998/api/admin/tracks" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {admin_token}" \
  -d '{
    "title": "æ–°æ­Œæµ‹è¯•",
    "artist": "æµ‹è¯•æ­Œæ‰‹",
    "category": "æµè¡Œ",
    "language": "ä¸­æ–‡"
  }'
```

2. **ä¸Šä¼ è§†é¢‘æ–‡ä»¶**
```bash
curl -X POST "http://localhost:9998/api/admin/tracks/1001/media/upload" \
  -H "Authorization: Bearer {admin_token}" \
  -F "file=@æ–°æ­Œæµ‹è¯•.mp4" \
  -F "fileType=VIDEO" \
  -F "quality=1080P"
```

3. **ä¸Šä¼ å°é¢å›¾ç‰‡**
```bash
curl -X POST "http://localhost:9998/api/admin/tracks/1001/media/upload" \
  -H "Authorization: Bearer {admin_token}" \
  -F "file=@å°é¢.jpg" \
  -F "fileType=COVER"
```

4. **ä¸Šä¼ æ­Œè¯æ–‡ä»¶**
```bash
curl -X POST "http://localhost:9998/api/admin/tracks/1001/media/upload" \
  -H "Authorization: Bearer {admin_token}" \
  -F "file=@æ­Œè¯.lrc" \
  -F "fileType=LYRICS"
```

5. **å¼ºåˆ¶æ¨é€åˆ°æ‰€æœ‰åŒ…é—´**
```bash
curl -X POST "http://localhost:9998/api/admin/tracks/sync-version/force-push" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {admin_token}" \
  -d '[1001]'
```

## ğŸ“ åŒæ­¥ç‰ˆæœ¬ç®¡ç†è¯´æ˜

### ç‰ˆæœ¬å·è§„åˆ™
- æ–°æ­Œæ›²åˆ›å»ºï¼š`sync_version = 1`
- é‡è¦æ›´æ–°ï¼š`sync_version += 1`
- åª’ä½“æ–‡ä»¶æ›´æ–°ï¼š`sync_version += 1`
- åˆ é™¤æ“ä½œï¼š`sync_version += 1`

### è‡ªåŠ¨æ›´æ–°ç‰ˆæœ¬çš„æƒ…å†µ
- æ­Œæ›²æ ‡é¢˜ã€æ­Œæ‰‹åå˜æ›´
- å°é¢å›¾ç‰‡æ›´æ–°
- çŠ¶æ€å˜æ›´ï¼ˆACTIVE â†’ DELETEDï¼‰
- åª’ä½“æ–‡ä»¶ä¸Šä¼ 
- å¼ºåˆ¶æ›´æ–°æ ‡å¿— `forceUpdateVersion=true`

### åŒ…é—´åŒæ­¥æœºåˆ¶
1. åŒ…é—´å®šæ—¶æ£€æŸ¥äº‘ç«¯æ›´æ–°ï¼ˆæ¯å°æ—¶ï¼‰
2. æ¯”è¾ƒæœ¬åœ° `sync_version` ä¸äº‘ç«¯ç‰ˆæœ¬
3. ä¸‹è½½æ›´æ–°çš„åª’ä½“æ–‡ä»¶
4. æ›´æ–°æœ¬åœ°æ­Œæ›²ä¿¡æ¯
5. è®°å½•åŒæ­¥æ—¥å¿—

## ğŸ”§ é”™è¯¯å¤„ç†

### å¸¸è§é”™è¯¯ç 
- `404`: æ­Œæ›²ä¸å­˜åœ¨
- `400`: è¯·æ±‚å‚æ•°é”™è¯¯
- `413`: æ–‡ä»¶è¿‡å¤§
- `415`: ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼
- `500`: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯

### é”™è¯¯å“åº”æ ¼å¼
```json
{
  "code": 404,
  "message": "æ­Œæ›²ä¸å­˜åœ¨",
  "data": null,
  "timestamp": "2024-08-29T16:30:00"
}
```

## ğŸ“ˆ ç›‘æ§æŒ‡æ ‡

å»ºè®®ç›‘æ§ä»¥ä¸‹å…³é”®æŒ‡æ ‡ï¼š
- æ¯æ—¥æ–°å¢æ­Œæ›²æ•°é‡
- åª’ä½“æ–‡ä»¶ä¸Šä¼ æˆåŠŸç‡
- åŒ…é—´åŒæ­¥æˆåŠŸç‡
- å¹³å‡åŒæ­¥å»¶è¿Ÿæ—¶é—´
- CDNå¸¦å®½ä½¿ç”¨æƒ…å†µ
- å­˜å‚¨ç©ºé—´ä½¿ç”¨æƒ…å†µ

---

é€šè¿‡è¿™å¥—å®Œæ•´çš„äº‘ç«¯ç®¡ç†æ¥å£ï¼Œç®¡ç†å‘˜å¯ä»¥é«˜æ•ˆåœ°ç®¡ç†æ•´ä¸ªæ›²åº“ç³»ç»Ÿï¼Œç¡®ä¿æ‰€æœ‰åŒ…é—´éƒ½èƒ½åŠæ—¶è·å¾—æœ€æ–°çš„æ­Œæ›²å†…å®¹å’Œæ›´æ–°ã€‚
